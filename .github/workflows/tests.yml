name: Tests & PR Checks
on:
  push:
    branches: [ dev ]
  pull_request:
    branches: [ main, dev ]

jobs:
  test:
    name: ğŸ§ª Run Tests
    timeout-minutes: 15
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
      with:
        lfs: true
    
    - uses: pnpm/action-setup@v4
      with:
        version: 10
        
    - uses: actions/setup-node@v4
      with:
        node-version: 22
        cache: 'pnpm'

    - name: ğŸ§© Install dependencies
      run: pnpm install --frozen-lockfile

    - name: ğŸ” Get Playwright version
      id: playwright-version
      run: echo "version=$(pnpm list @playwright/test --depth=0 | grep @playwright/test | awk '{print $2}')" >> $GITHUB_OUTPUT

    - name: ğŸ“¥ Cache Playwright Browsers
      id: playwright-cache
      uses: actions/cache@v4
      with:
        path: ~/.cache/ms-playwright
        key: ${{ runner.os }}-playwright-${{ steps.playwright-version.outputs.version }}

    - name: âš™ï¸ Install Playwright Browsers
      if: steps.playwright-cache.outputs.cache-hit != 'true'
      run: pnpm exec playwright install --with-deps chromium

    - name: ğŸ’¾ Cache Next.js build
      uses: actions/cache@v4
      with:
        path: |
          ${{ github.workspace }}/.next/cache
        key: ${{ runner.os }}-nextjs-${{ hashFiles('**/pnpm-lock.yaml') }}-${{ hashFiles('**/*.js', '**/*.jsx', '**/*.ts', '**/*.tsx', '**/*.mdx') }}
        restore-keys: |
          ${{ runner.os }}-nextjs-${{ hashFiles('**/pnpm-lock.yaml') }}-

    - name: ğŸ–¼ï¸ Cache optimized images
      uses: actions/cache@v4
      with:
        path: |
          .image-cache
          public/images/next-image-export-optimizer-hashes.json
        key: ${{ runner.os }}-next-images-${{ hashFiles('public/images/**/*', 'next.config.mjs') }}
        restore-keys: |
          ${{ runner.os }}-next-images-

    - name: ğŸ—ï¸ Export website (optimizes images)
      env:
        nextImageExportOptimizer_imageSizes: "16,64,128,256,384"
        nextImageExportOptimizer_deviceSizes: "640,1080,1920"
      run: |
        pnpm build
        mkdir -p out/nextImageExportOptimizer
        if [ -d ".image-cache" ]; then
          echo "Restoring images from cache..."
          cp -r .image-cache/* out/nextImageExportOptimizer/ || true
        fi
        pnpm next-image-export-optimizer
        node scripts/inline-css.mjs
        mkdir -p .image-cache
        cp -r out/nextImageExportOptimizer/* .image-cache/

    - name: ğŸš¦ Run tests
      run: pnpm test:all

    - uses: actions/upload-artifact@v4
      if: always()
      with:
        name: test-results
        path: test-results/
        retention-days: 30

  preview-release:
    name: ğŸš€ Release Preview
    if: github.event_name == 'pull_request' && github.base_ref == 'main'
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ“¥ Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: ${{ github.head_ref }}

      - name: ğŸŸ¢ Use Node.js 22
        uses: actions/setup-node@v4
        with:
          node-version: 22

      - name: ğŸ“¦ Install pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 10

      - name: ğŸ§© Install dependencies
        run: pnpm install --frozen-lockfile

      - name: ğŸ” Semantic Release Dry Run
        id: semantic
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          HEAD_REF: ${{ github.head_ref }}
          NEXT_TELEMETRY_DISABLED: 1
        run: node .github/scripts/release-preview.mjs

      - name: ğŸ’¬ Update PR
        if: steps.semantic.outputs.version != ''
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          VERSION: ${{ steps.semantic.outputs.version }}
          NOTES: ${{ steps.semantic.outputs.notes }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
        run: |
          gh pr edit "$PR_NUMBER" \
            --title "chore(release): v$VERSION" \
            --body "### ğŸš€ Release Preview: v$VERSION
          
          _This description is automatically generated based on the commits in this Pull Request._
          
          $NOTES"