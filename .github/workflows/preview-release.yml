name: Release Preview

on:
  pull_request:
    branches:
      - main
    types: [opened, synchronize, reopened]

permissions:
  contents: read
  pull-requests: write

jobs:
  preview:
    name: Preview Release
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Install dependencies
        run: npm install -g pnpm && pnpm install --frozen-lockfile

      - name: Semantic Release Dry Run
        id: semantic
        uses: cycjimmy/semantic-release-action@v4
        with:
          dry_run: true
          # Allow the current branch (head of PR) to trigger a release simulation
          branches: |
            [
              "${{ github.head_ref }}"
            ]
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Update PR
        if: steps.semantic.outputs.new_release_published == 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          VERSION: ${{ steps.semantic.outputs.new_release_version }}
          NOTES: ${{ steps.semantic.outputs.new_release_notes }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
        run: |
          gh pr edit "$PR_NUMBER" \
            --title "chore(release): v$VERSION" \
            --body "### ðŸš€ Release Preview: v$VERSION
          
          _This description is automatically generated based on the commits in this Pull Request._
          
          $NOTES"
