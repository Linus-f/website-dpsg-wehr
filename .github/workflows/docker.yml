name: Build and Push Docker Image

on:
  push:
    tags:
      - 'v*'
  workflow_run:
    workflows: ["Release"]
    types:
      - completed

permissions:
  contents: read
  packages: write

jobs:
  build-and-push:
    if: ${{ github.event_name == 'push' || github.event.workflow_run.conclusion == 'success' }}
    runs-on: ubuntu-latest
    steps:
      - name: üì• Checkout
        uses: actions/checkout@v4
        with:
          lfs: true
          fetch-depth: 0
          ref: ${{ github.event_name == 'workflow_run' && 'main' || '' }}

      - name: üè∑Ô∏è Detect Release Tag
        id: check
        run: |
          if [ "${{ github.event_name }}" == "workflow_run" ]; then
            # Check if the current commit (HEAD of main) is tagged
            if TAG=$(git describe --tags --exact-match 2>/dev/null); then
              echo "Found release tag: $TAG"
              echo "TAG=$TAG" >> $GITHUB_ENV
              
              # Parse semver parts (assuming vX.Y.Z format)
              VERSION=${TAG#v}
              echo "VERSION=$VERSION" >> $GITHUB_ENV
              
              MAJOR_MINOR=$(echo "$VERSION" | cut -d. -f1-2)
              echo "MAJOR_MINOR=$MAJOR_MINOR" >> $GITHUB_ENV
              
              echo "is_release=true" >> $GITHUB_OUTPUT
            else
              echo "No tag found on HEAD. Skipping release build."
              echo "is_release=false" >> $GITHUB_OUTPUT
            fi
          else
            # For direct tag pushes, we proceed as normal
            echo "is_release=true" >> $GITHUB_OUTPUT
          fi

      - name: üì¶ Install pnpm
        if: steps.check.outputs.is_release == 'true'
        uses: pnpm/action-setup@v4
        with:
          version: 10

      - name: üü¢ Use Node.js 22
        if: steps.check.outputs.is_release == 'true'
        uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: 'pnpm'

      - name: üß© Install dependencies
        if: steps.check.outputs.is_release == 'true'
        run: pnpm install --frozen-lockfile

      - name: üíæ Restore Image Cache
        if: steps.check.outputs.is_release == 'true'
        id: image-cache
        uses: actions/cache@v4
        with:
          path: |
            .next/cache
            .image-cache
            public/images/next-image-export-optimizer-hashes.json
          key: ${{ runner.os }}-next-images-${{ hashFiles('public/images/**/*') }}
          restore-keys: |
            ${{ runner.os }}-next-images-

      - name: üèóÔ∏è Build & Optimize
        if: steps.check.outputs.is_release == 'true'
        run: |
          pnpm next build
          mkdir -p out/nextImageExportOptimizer
          if [ -d ".image-cache" ]; then
            cp -r .image-cache/* out/nextImageExportOptimizer/ || true
          fi
          pnpm next-image-export-optimizer
          mkdir -p .image-cache
          cp -r out/nextImageExportOptimizer/* .image-cache/

      - name: üîê Log in to GHCR
        if: steps.check.outputs.is_release == 'true'
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: üî° Lowercase Repo Name
        if: steps.check.outputs.is_release == 'true'
        run: echo "IMAGE_NAME=ghcr.io/$(echo ${{ github.repository }} | tr '[:upper:]' '[:lower:]')" >> $GITHUB_ENV
      
      - name: üè∑Ô∏è Extract Metadata
        if: steps.check.outputs.is_release == 'true'
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.IMAGE_NAME }}
          tags: |
            type=semver,pattern={{version}}
            type=semver,pattern={{major}}.{{minor}}
            type=raw,value=latest
            type=raw,value=${{ env.TAG }},enable=${{ github.event_name == 'workflow_run' }}
            type=raw,value=${{ env.VERSION }},enable=${{ github.event_name == 'workflow_run' }}
            type=raw,value=${{ env.MAJOR_MINOR }},enable=${{ github.event_name == 'workflow_run' }}

      - name: üê≥ Build and Push
        if: steps.check.outputs.is_release == 'true'
        uses: docker/build-push-action@v6
        with:
          context: .
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}